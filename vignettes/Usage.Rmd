---
title: "Usage of the Package magickx"
author: "Hauke Sonnenberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usage of the Package magickx}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Load the Packages

```{r}
library(magick)
library(magickx)
```

## Load Example Images

```{r}
# Define a Helper Function to Create URLs
to_image_url <- function(day_string, hours = 0:23) file.path(
  "http://wind.met.fu-berlin.de/loops/bwb", 
  sprintf("BWBRR_TEXT_%s_%02d00.gif", day_string, hours)
)

# Define different sets of URLs
urls_1 <- to_image_url(day_string = "20180417")
urls_2 <- to_image_url(day_string = "20170103")

# Show some URLs
head(urls_1)
```

### Read Images from URLs

#### Read with `image_read()`

With the `image_read()`-function of the `magick` package you can read images 
from many files or URLs in one function call. This function stops if there is
any path or URL from which no image could be read. The package `magickx` 
contains a function `try_image_read()` that does not stop on errors but skips 
the file that cannot be read and prints an error message. 

Using `image_read()` stops with an error:

```{r error = TRUE}
images <- magick::image_read(urls_1)
```

Nothing was assigned to the variable `images`:

```{r error = TRUE}
length(images)
```

#### Read with `try_image_read()`

Using `try_image_read()` shows the error message but continues:

```{r}
images <- magickx::try_image_read(urls_1) # All files can be read
```

The variable `images` now contains two (out of three) images (one was skipped):

```{r}
length(images)
```

For the following examples, we will download images from the second set of URLs
`urls_2` (without any error):

```{r}
images <- try_image_read(urls_2)
```

## Show Example Images

The variable `images` is a vector of `r length(images)` images. If you print 
them, they will be overlayed:

```{r}
print(images)
```

Using `image_animate()` from the `magick` package we can show them all one after
each other:

```{r}
image_animate(images, fps = 2)
```

## Define Crop Areas

```{r}
# Define path to file in the package containing crop information
file <- system.file("extdata/crop_info.csv", package = "magickx")

# Load the crop information from the file
crop_info <- read.table(file, stringsAsFactors = FALSE)

# Specify rows of interest
row_names <- c("DateTime", grep("^bwb[0:1]", rownames(crop_info), value = TRUE))

# Select the geometry strings of rows of interest and name them
geometries <- setNames(crop_info[row_names, "geometry"], row_names)

# Show the geometry strings
geometries
```

## Create Columns from Cropped Parts of the Images

```{r eval = TRUE}
# Crop area "DateTime" in each image and append the areas vertically
image_matrix(image_crop(images, geometries["DateTime"]))

# Crop area "bwb15" in each image and append the areas horizontally
image_matrix(image_crop(images, geometries["bwb15"]), nrow = 1)
```

## Append Image Columns Next to Each Other

```{r eval = TRUE}
# Use all geometries to crop areas, append them vertically and append the
# resulting column images horizontally
gauge_images <- lapply(geometries, image_crop, image = images)

# Number of columns in image matrix to be created
n_col <- length(gauge_images)

# Arrange vector of images in a matrix
page_image <- image_matrix(list_to_magick(gauge_images), ncol = n_col)

# Show the resulting image
page_image
```

## Select Rows or Columns from an Image

```{r}
# Select rows and columns
extract(page_image, 1:10, 1:10)

# Exclude rows or columns with negative indices
extract(page_image, -(5:15), -c(9:10, 18))
```

```{r echo = FALSE}
#border <- c(10, 10)
#widths  <- crop_info[, "width"] + border[1]
#heights <- crop_info[, "height"] + border[2]
```
